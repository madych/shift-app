<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚·ãƒ•ãƒˆè¡¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: sans-serif; padding: 10px; }
h2 { margin-bottom: 6px; }

.controls { margin-bottom: 8px; }
button { margin: 3px; padding: 6px 10px; }

table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border: 1px solid #999;
  padding: 6px;
  text-align: center;
}
th { background: #f0f0f0; }

.name-input {
  border: none;
  width: 95%;
  text-align: center;
  font-size: 14px;
}

.shift-cell {
  min-height: 28px;
  cursor: pointer;
  user-select: none;
}
</style>
</head>

<body>

<h2>ã‚·ãƒ•ãƒˆè¡¨ï¼ˆæœˆæ›œã¯ã˜ã¾ã‚Šãƒ»æœˆã€œåœŸï¼‰</h2>

<div class="controls">
  <button onclick="prevWeek()">â—€ å‰é€±</button>
  <strong id="weekLabel"></strong>
  <button onclick="nextWeek()">æ¬¡é€± â–¶</button>
</div>

<div class="controls">
  <button onclick="addStaff()">ï¼‹ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </button>
  <button onclick="makeImage()">ğŸ“¸ ç”»åƒâ†’LINE</button>
</div>

<table id="shiftTable">
  <tr id="headerRow">
    <th>åå‰</th>
  </tr>
</table>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ===== é€±ãƒ»æ—¥ä»˜ ===== */
let currentMonday = getMonday(new Date());

function getMonday(d) {
  const date = new Date(d);
  const day = date.getDay();
  const diff = (day === 0 ? -6 : 1) - day;
  date.setDate(date.getDate() + diff);
  return date;
}

function formatDate(d) {
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function weekKey() {
  return currentMonday.toISOString().slice(0,10);
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
function updateWeekLabel() {
  document.getElementById("weekLabel").textContent =
    `${formatDate(currentMonday)} é€±`;
  updateHeader();
}

function updateHeader() {
  const header = document.getElementById("headerRow");
  const days = ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  header.innerHTML = "<th>åå‰</th>";
  for (let i = 0; i < 6; i++) {
    const d = new Date(currentMonday);
    d.setDate(d.getDate() + i);
    header.innerHTML += `<th>${days[i]}<br>${formatDate(d)}</th>`;
  }
}

/* ===== é€±åˆ‡æ›¿ ===== */
function prevWeek() {
  saveWeek();
  currentMonday.setDate(currentMonday.getDate() - 7);
  loadWeek();
}

function nextWeek() {
  saveWeek();
  currentMonday.setDate(currentMonday.getDate() + 7);
  loadWeek();
}

/* ===== è¡¨æ“ä½œ ===== */
function addStaff(name = "æ–°è¦") {
  const table = document.getElementById("shiftTable");
  const row = table.insertRow();

  row.innerHTML = `
    <td><input class="name-input" value="${name}" onchange="saveWeek()"></td>
    ${"<td class='shift-cell'></td>".repeat(6)}
  `;

  row.querySelectorAll(".shift-cell").forEach(cell => {
    cell.addEventListener("click", () => toggleCell(cell));
  });

  saveWeek();
}

/* ===== ã‚¿ãƒƒãƒ—åˆ‡æ›¿ï¼‹è‡ªç”±å…¥åŠ› ===== */
function toggleCell(cell) {
  const presets = ["", "ã€‡", "9:00ã€œ", "17:00ã€œ", "19:00ã€œ"];
  const current = cell.textContent.trim();
  const index = presets.indexOf(current);

  if (index === presets.length - 1) {
    const input = prompt("è‡ªç”±å…¥åŠ›ï¼ˆä¾‹ï¼š13:00ã€œ18:00ã€ä¼‘ã¿ ç­‰ï¼‰", "");
    cell.textContent = input ? input : "";
  } else {
    cell.textContent = presets[index + 1];
  }
  saveWeek();
}

/* ===== é€±ã”ã¨ä¿å­˜ ===== */
function saveWeek() {
  const data = [];
  const rows = document.querySelectorAll("#shiftTable tr");
  rows.forEach((row, i) => {
    if (i === 0) return;
    const name = row.cells[0].querySelector("input").value;
    const shifts = [];
    for (let j = 1; j <= 6; j++) {
      shifts.push(row.cells[j].textContent.trim());
    }
    data.push({ name, shifts });
  });
  localStorage.setItem("shift_" + weekKey(), JSON.stringify(data));
}

/* ===== é€±èª­ã¿è¾¼ã¿ ===== */
function loadWeek() {
  updateWeekLabel();

  // è¡¨ã‚¯ãƒªã‚¢ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ï¼‰
  const table = document.getElementById("shiftTable");
  while (table.rows.length > 1) table.deleteRow(1);

  const saved = localStorage.getItem("shift_" + weekKey());
  if (!saved) return;

  const data = JSON.parse(saved);
  data.forEach(staff => {
    const row = table.insertRow();
    row.innerHTML = `
      <td><input class="name-input" value="${staff.name}" onchange="saveWeek()"></td>
      ${staff.shifts.map(v => `<td class="shift-cell">${v}</td>`).join("")}
    `;
    row.querySelectorAll(".shift-cell").forEach(cell => {
      cell.addEventListener("click", () => toggleCell(cell));
    });
  });
}

/* ===== ç”»åƒ â†’ LINE ===== */
function makeImage() {
  html2canvas(document.getElementById("shiftTable")).then(canvas => {
    canvas.toBlob(blob => {
      const file = new File([blob], "shift.png", { type: "image/png" });
      if (navigator.share) {
        navigator.share({ files: [file] });
      } else {
        const url = URL.createObjectURL(blob);
        window.open(url);
        alert("ç”»åƒã‚’é•·æŠ¼ã— â†’ å…±æœ‰ â†’ LINE");
      }
    });
  });
}

/* ===== åˆæœŸè¡¨ç¤º ===== */
loadWeek();
if (document.querySelectorAll("#shiftTable tr").length === 1) {
  addStaff("ç”°ä¸­");
  addStaff("ä½è—¤");
}
</script>

</body>
</html>
